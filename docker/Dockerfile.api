# Dockerfile for FastAPI Server
# Separate container for the API server

FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
# - build-essential: For compiling Python packages
# - chromium & chromium-driver: For Selenium web scraping
# - git: For installing packages from git repositories
# - curl: For health checks
RUN apt-get update && apt-get install -y \
    build-essential \
    chromium \
    chromium-driver \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set environment variables for Chromium
ENV CHROME_BIN=/usr/bin/chromium
ENV CHROMEDRIVER_PATH=/usr/bin/chromedriver
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Create non-root user
RUN useradd -m -u 1000 trader && \
    chown -R trader:trader /app

# Copy requirements files
COPY requirements.txt ./
COPY server/requirements.txt ./server-requirements.txt

# Install dependencies (main requirements first, then server-specific)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir -r server-requirements.txt && \
    # Install Kotak Neo SDK without dependencies (to avoid numpy conflicts)
    pip install --no-cache-dir --no-deps git+https://github.com/Kotak-Neo/kotak-neo-api@67143c58f29da9572cdbb273199852682a0019d5#egg=neo-api-client && \
    # Install minimal required dependencies for neo_api_client
    # Note: PyJWT and python-dateutil are already in requirements.txt
    # websocket-client is separate from websockets (both needed)
    # Use websockets>=13 for uvicorn compatibility (Kotak SDK works with newer versions)
    pip install --no-cache-dir PyJWT==2.6.0 websocket-client==1.5.1 websockets>=13.0 python-dateutil==2.9.0.post0 && \
    # Verify SDK can be imported
    python -c "from neo_api_client import NeoAPI; print('âœ“ Kotak Neo SDK installed successfully')" || \
    (echo "ERROR: Failed to install Kotak Neo SDK" && exit 1)

# Copy entire project (API needs access to src/, models/, etc.)
COPY . .

# Create directories with proper permissions
RUN mkdir -p data logs paper_trading && \
    chown -R trader:trader /app

USER trader

# Expose API port
EXPOSE 8000

# Create startup script that runs migrations then starts the server
# Includes safe migration recovery with schema validation
RUN echo '#!/bin/bash' > /app/start.sh && \
    echo 'set +e' >> /app/start.sh && \
    echo 'echo "Checking database migration status..."' >> /app/start.sh && \
    echo 'echo "Running database migrations..."' >> /app/start.sh && \
    echo 'MIGRATION_OUTPUT=$(python -m alembic upgrade head 2>&1)' >> /app/start.sh && \
    echo 'MIGRATION_EXIT=$?' >> /app/start.sh && \
    echo 'echo "$MIGRATION_OUTPUT"' >> /app/start.sh && \
    echo 'if [ $MIGRATION_EXIT -ne 0 ]; then' >> /app/start.sh && \
    echo '  if echo "$MIGRATION_OUTPUT" | grep -q "Can'\''t locate revision"; then' >> /app/start.sh && \
    echo '    echo "WARNING: Database references missing revision. Attempting safe recovery..."' >> /app/start.sh && \
    echo '    python << EOF' >> /app/start.sh && \
    echo 'import sqlite3' >> /app/start.sh && \
    echo 'import os' >> /app/start.sh && \
    echo 'from sqlalchemy import create_engine, inspect' >> /app/start.sh && \
    echo 'db_url = os.getenv("DB_URL", "sqlite:///./data/app.db")' >> /app/start.sh && \
    echo 'db_path = db_url.replace("sqlite:///", "") if db_url.startswith("sqlite:///") else db_url' >> /app/start.sh && \
    echo 'if not os.path.exists(db_path):' >> /app/start.sh && \
    echo '    print("INFO: Database does not exist, will be created by migrations")' >> /app/start.sh && \
    echo '    exit(0)' >> /app/start.sh && \
    echo 'try:' >> /app/start.sh && \
    echo '    engine = create_engine(f"sqlite:///{db_path}")' >> /app/start.sh && \
    echo '    inspector = inspect(engine)' >> /app/start.sh && \
    echo '    tables = inspector.get_table_names()' >> /app/start.sh && \
    echo '    critical_tables = ["users", "orders", "positions", "alembic_version"]' >> /app/start.sh && \
    echo '    missing_tables = [t for t in critical_tables if t not in tables]' >> /app/start.sh && \
    echo '    if missing_tables:' >> /app/start.sh && \
    echo '        print(f"WARNING: Missing critical tables: {missing_tables}")' >> /app/start.sh && \
    echo '        print("WARNING: Schema appears incomplete. Proceeding anyway...")' >> /app/start.sh && \
    echo '    if "orders" in tables:' >> /app/start.sh && \
    echo '        orders_cols = {c["name"] for c in inspector.get_columns("orders")}' >> /app/start.sh && \
    echo '        required_cols = {"id", "user_id", "symbol", "status", "placed_at"}' >> /app/start.sh && \
    echo '        missing_cols = required_cols - orders_cols' >> /app/start.sh && \
    echo '        if missing_cols:' >> /app/start.sh && \
    echo '            print(f"WARNING: Orders table missing columns: {missing_cols}")' >> /app/start.sh && \
    echo '    conn = sqlite3.connect(db_path)' >> /app/start.sh && \
    echo '    conn.execute("DELETE FROM alembic_version")' >> /app/start.sh && \
    echo '    conn.commit()' >> /app/start.sh && \
    echo '    conn.close()' >> /app/start.sh && \
    echo '    print("SUCCESS: Cleared alembic_version table")' >> /app/start.sh && \
    echo '    engine.dispose()' >> /app/start.sh && \
    echo '    exit(0)' >> /app/start.sh && \
    echo 'except Exception as e:' >> /app/start.sh && \
    echo '    print(f"ERROR: Failed to fix migration revision: {e}")' >> /app/start.sh && \
    echo '    exit(1)' >> /app/start.sh && \
    echo 'EOF' >> /app/start.sh && \
    echo '    FIX_EXIT=$?' >> /app/start.sh && \
    echo '    if [ $FIX_EXIT -eq 0 ]; then' >> /app/start.sh && \
    echo '      echo "Stamping database to head..."' >> /app/start.sh && \
    echo '      python -m alembic stamp head || echo "WARNING: Could not stamp database"' >> /app/start.sh && \
    echo '      echo "Retrying migrations..."' >> /app/start.sh && \
    echo '      python -m alembic upgrade head || echo "WARNING: Migration failed after stamp, continuing anyway..."' >> /app/start.sh && \
    echo '    else' >> /app/start.sh && \
    echo '      echo "ERROR: Schema validation failed. Database may be incomplete."' >> /app/start.sh && \
    echo '      echo "WARNING: Continuing anyway, but manual database fix may be required."' >> /app/start.sh && \
    echo '    fi' >> /app/start.sh && \
    echo '  else' >> /app/start.sh && \
    echo '    echo "WARNING: Migration failed with unknown error, continuing anyway..."' >> /app/start.sh && \
    echo '  fi' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo 'echo "Starting API server..."' >> /app/start.sh && \
    echo 'exec uvicorn server.app.main:app --host 0.0.0.0 --port 8000' >> /app/start.sh && \
    chmod +x /app/start.sh

# Run migrations then start the API server
CMD ["/app/start.sh"]
